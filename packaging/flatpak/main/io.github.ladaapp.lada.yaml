id: io.github.ladaapp.lada
runtime: org.gnome.Platform
runtime-version: '49'
desktop-file-name-suffix: " (dev)"
default-branch: "main"
sdk: org.gnome.Sdk
command: lada
finish-args:
  - "--socket=wayland"
  - "--socket=fallback-x11"
  - "--device=dri"
  - "--share=ipc"
  - "--socket=pulseaudio"
  - "--talk-name=org.gnome.SessionManager" # Post-export automatic system shutdown on GNOME desktops
  - "--talk-name=org.kde.Shutdown" # Post-export automatic system shutdown on KDE desktops
  - "--env=LADA_MODEL_WEIGHTS_DIR=/app/model_weights"
  - "--env=LOCALE_DIR=/app/lib/python3.13/site-packages/lada/locale"
  - "--env=YOLO_CONFIG_DIR=/var/config/yolo"
  - "--env=PYTHONPATH=/app/extensions/lib/python3.13/site-packages"
  - "--env=LD_LIBRARY_PATH=/app/lib"
  - "--env=LIBVA_MESSAGING_LEVEL=1" # set log level to error to suppress initialization logs at startup
add-extensions:
  io.github.ladaapp.lada.extensions:
    directory: extensions
    merge-dirs: lib;bin
    no-autodownload: true
    autodelete: true
    subdirectories: true
cleanup-commands:
  - mkdir ${FLATPAK_DEST}/extensions
modules:
  - name: intel-onevpl-runtime # Needed for QSV encoders as it's not included in org.freedesktop.Platform.VAAPI.Intel
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - '-DCMAKE_BUILD_TYPE=Release'
      - '-DBUILD_SAMPLES=OFF'
      - '-DBUILD_TESTS=OFF'
      - '-DBUILD_TOOLS=OFF'
    sources:
      - type: archive
        url: https://github.com/oneapi-src/oneVPL-intel-gpu/archive/intel-onevpl-25.4.6.tar.gz
        sha256: a4cc2429fba49ee1d5f48883930e2e7325f0af38af83c8048793c8b1d3fa4a8f
  - python-dependencies.yaml
  - name: lada-model-weights
    buildsystem: simple
    build-commands:
      - |
        mkdir -p /app/model_weights/3rd_party
        mv lada_*.pt{,h} /app/model_weights/
        mv clean_youknow_video.pth /app/model_weights/3rd_party/
    sources:
      - type: file
        url: "https://huggingface.co/ladaapp/lada/resolve/main/lada_mosaic_detection_model_v2.pt?download=true"
        sha256: 056756fcab250bcdf0833e75aac33e2197b8809b0ab8c16e14722dcec94269b5
      - type: file
        url: "https://huggingface.co/ladaapp/lada/resolve/main/lada_mosaic_detection_model_v4_accurate.pt?download=true"
        sha256: c244d7e49d8f88e264b8dc15f91fb21f5908ad8fb6f300b7bc88462d0801bc1f
      - type: file
        url: "https://huggingface.co/ladaapp/lada/resolve/main/lada_mosaic_detection_model_v4_fast.pt?download=true"
        sha256: 9a6b660d1d3e3797d39515e08b0e72fcc59815f38279faa7a4ab374ab2c1e3b4
      - type: file
        url: "https://huggingface.co/ladaapp/lada/resolve/main/lada_mosaic_restoration_model_generic_v1.2.pth?download=true"
        sha256: d404152576ce64fb5b2f315c03062709dac4f5f8548934866cd01c823c8104ee
      - type: file
        url: "https://drive.usercontent.google.com/download?id=1ulct4RhRxQp1v5xwEmUH7xz7AK42Oqlw&export=download&confirm=t"
        sha256: 5643ca297c13920b8ffd39a0d85296e494683a69e5e8204d662653d24c582766
        dest-filename: clean_youknow_video.pth
  - name: lada
    buildsystem: simple
    build-commands:
      - sh translations/compile_po.sh --release
      - python3 -m pip install --prefix=/app --no-deps --no-build-isolation '.[gui]'
      - |
        mkdir -p /app/share/applications /app/share/metainfo /app/share/icons/hicolor/128x128/apps
        install -m 644 packaging/flatpak/main/io.github.ladaapp.lada.desktop /app/share/applications
        install -m 644 packaging/flatpak/main/io.github.ladaapp.lada.metainfo.xml /app/share/metainfo
        install -m 644 assets/io.github.ladaapp.lada.png /app/share/icons/hicolor/128x128/apps
      - |
        patch -u -p1 -d /app/lib/python3.13/site-packages < $FLATPAK_BUILDER_BUILDDIR/patches/increase_mms_time_limit.patch
        patch -u -p1 -d /app/lib/python3.13/site-packages < $FLATPAK_BUILDER_BUILDDIR/patches/remove_ultralytics_telemetry.patch
        patch -u -p1 -d /app/lib/python3.13/site-packages < $FLATPAK_BUILDER_BUILDDIR/patches/fix_loading_mmengine_weights_on_torch26_and_higher.diff
    sources:
      - type: dir
        path: "../../.."
